<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Piano Flow</title>
    <style>
        :root {
            --bg-dark: #0a0c0e;
            --card-bg: #16191d;
            --accent: #00d4ff;
            --accent-glow: rgba(0, 212, 255, 0.4);
            --correct: #2ecc71;
            --wrong: #ff4757;
            --white-key: #fdfdfd;
            --black-key: #252a2e;
            --text-main: #ffffff;
            --text-dim: #7f8c8d;
            --white-key-w: 48px;
            --white-key-h: 150px;
        }

        * {
            touch-action: manipulation;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            height: 100dvh;
            width: 100vw;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        #orientation-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-dark);
            z-index: 9999;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        @media (orientation: portrait) {
            #orientation-overlay {
                display: flex;
            }
        }

        .container {
            width: 100%;
            height: 100%;
            max-width: 1100px;
            background: var(--card-bg);
            padding: 15px;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow-y: auto;
            /* ÂÖÅËÆ∏ÂØπÁÖßË°®Â±ïÂºÄÊó∂ÊªöÂä®Êü•Áúã */
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-shrink: 0;
        }

        header h1 {
            margin: 0;
            font-size: 1.1rem;
            letter-spacing: 1px;
            color: var(--accent);
            cursor: pointer;
        }

        .top-ctrl {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .tool-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #fff;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: 0.2s;
        }

        .tool-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .tool-btn.active {
            background: var(--accent);
            color: #000;
        }

        .mode-selector {
            display: flex;
            gap: 4px;
            background: rgba(0, 0, 0, 0.4);
            padding: 4px;
            border-radius: 8px;
        }

        .mode-btn {
            padding: 6px 14px;
            border: none;
            border-radius: 6px;
            background: transparent;
            color: var(--text-dim);
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .mode-btn.active {
            background: var(--accent);
            color: #000;
            box-shadow: 0 0 10px var(--accent-glow);
        }

        /* ÂØπÁÖßË°®Èù¢Êùø */
        #ref-panel {
            max-height: 0;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        #ref-panel.open {
            max-height: 300px;
            padding: 10px;
            border: 1px solid rgba(0, 212, 255, 0.2);
            overflow: auto;
        }

        .ref-table {
            width: max-content;
            min-width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 0.75rem;
            color: #ccc;
        }

        .ref-table th {
            color: var(--accent);
            text-align: left;
            padding: 4px;
            border-bottom: 1px solid #333;
            background: var(--card-bg);
            position: sticky;
            top: 0;
            z-index: 3;
        }

        .ref-table td {
            padding: 4px;
            border-bottom: 1px solid #222;
        }

        .ref-table th:first-child,
        .ref-table td:first-child {
            position: sticky;
            left: 0;
            background: var(--card-bg);
            z-index: 2;
        }

        .ref-table thead th:first-child {
            z-index: 4;
        }

        .ref-col-hidden {
            display: none;
        }

        .ref-highlight {
            color: #fff;
            font-weight: bold;
        }

        .ref-hidden {
            display: none;
        }

        .degree-ref {
            font-size: 0.78rem;
            color: #cfd6db;
        }

        .degree-title {
            color: var(--accent);
            font-weight: 700;
            margin-bottom: 6px;
        }

        .degree-notes {
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .degree-kbd {
            display: flex;
            position: relative;
            width: fit-content;
            background: #000;
            padding: 4px;
            border-radius: 8px;
            height: 86px;
        }

        .degree-key {
            width: 16px;
            height: 78px;
            background: var(--white-key);
            border: 1px solid #ccd3da;
            border-radius: 0 0 4px 4px;
            position: relative;
            z-index: 1;
        }

        .degree-key.black {
            width: 10px;
            height: 50px;
            background: var(--black-key);
            margin-left: -5px;
            margin-right: -5px;
            border: none;
            z-index: 2;
            border-radius: 0 0 4px 4px;
        }

        .degree-key.hit {
            background: rgba(46, 204, 113, 0.95) !important;
        }

        .degree-key.root {
            background: var(--accent) !important;
            box-shadow: 0 0 10px var(--accent-glow);
        }

        .degree-num {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: 6px;
            font-size: 0.6rem;
            font-weight: 800;
            color: #0b1218;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            min-width: 12px;
            text-align: center;
            line-height: 1;
            padding: 2px 3px;
        }

        .degree-key.black .degree-num {
            bottom: 4px;
            font-size: 0.52rem;
            min-width: 10px;
            padding: 1px 2px;
        }

        .chip-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 6px;
            margin-bottom: 5px;
            flex-shrink: 0;
        }

        .chip {
            position: relative;
            cursor: pointer;
        }

        .chip input {
            position: absolute;
            opacity: 0;
        }

        .chip-content {
            display: block;
            padding: 8px 2px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            text-align: center;
            font-size: 0.75rem;
            color: #555;
            transition: 0.3s;
        }

        .chip input:checked+.chip-content {
            border-color: rgba(255, 255, 255, 0.3);
            color: #aaa;
        }

        .chip.target-highlight .chip-content {
            background: rgba(0, 212, 255, 0.2) !important;
            border-color: var(--accent) !important;
            color: var(--accent) !important;
            box-shadow: 0 0 12px var(--accent-glow);
            font-weight: bold;
            transform: scale(1.03);
        }

        .select-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            padding: 5px 0;
        }

        select {
            padding: 8px 25px 8px 12px;
            border-radius: 8px;
            background: #2d3436;
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 0.85rem;
            cursor: pointer;
        }

        .question-area {
            text-align: center;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 50px;
        }

        .feedback {
            font-size: 0.8rem;
            height: 1rem;
            margin-bottom: 3px;
            font-weight: 800;
            letter-spacing: 2px;
        }

        .question-text {
            font-size: 1.6rem;
            font-weight: 800;
            color: #fff;
        }

        .keyboard-wrapper {
            width: 100%;
            display: flex;
            justify-content: center;
            overflow-x: auto;
            padding-top: 5px;
            flex-shrink: 0;
        }

        .piano {
            display: flex;
            position: relative;
            width: fit-content;
            height: calc(var(--white-key-h) + 12px);
            background: #000;
            padding: 6px;
            border-radius: 12px;
        }

        .key {
            width: var(--white-key-w);
            height: var(--white-key-h);
            background: var(--white-key);
            border: 1px solid #ccc;
            border-radius: 0 0 5px 5px;
            cursor: pointer;
            position: relative;
            z-index: 1;
        }

        .key.black {
            width: 28px;
            height: 90px;
            background: var(--black-key);
            margin-left: -14px;
            margin-right: -14px;
            z-index: 2;
            border: none;
            border-radius: 0 0 4px 4px;
        }

        .key.root {
            background: var(--accent) !important;
            box-shadow: 0 0 15px var(--accent-glow);
        }

        .key.correct {
            background: var(--correct) !important;
        }

        .key.wrong {
            background: var(--wrong) !important;
        }

        @media (orientation: landscape) and (max-height: 450px) {
            .container {
                padding: 5px 15px;
            }

            .chip-grid {
                grid-template-columns: repeat(6, 1fr);
                gap: 4px;
            }

            .question-area {
                min-height: 35px;
            }

            .question-text {
                font-size: 1.2rem;
            }

            #ref-panel.open {
                max-height: 120px;
            }

            .container {
                --white-key-h: 100px;
                --white-key-w: 42px;
            }

            .key.black {
                height: 65px;
                width: 24px;
                margin-left: -12px;
                margin-right: -12px;
            }
        }

    </style>
</head>

<body>

    <div id="orientation-overlay">
        <span style="font-size: 3rem;">üîÑ</span>
        <p>ËØ∑ÊóãËΩ¨ÊâãÊú∫Ëá≥Ê®™Â±èÊ®°Âºè</p>
    </div>

    <div class="container" id="app-container">
        <header>
            <h1 onclick="location.reload()">PIANO FLOW</h1>
            <div class="top-ctrl">
                <button class="tool-btn" id="btn-ref" onclick="toggleRef()">üìö Âä©ËÆ∞ÊâãÂÜå</button>
                <button class="tool-btn" onclick="location.href='interval_memory.html'">üß† Âä©ËÆ∞‰∏ìÈ°µ</button>
                <button class="tool-btn" onclick="toggleFullScreen()">‚õ∂ ÂÖ®Â±è</button>
                <div class="mode-selector">
                    <button class="mode-btn active" id="btn-interval" onclick="switchMainMode('interval')">Èü≥Á®ã</button>
                    <button class="mode-btn" id="btn-degree" onclick="switchMainMode('degree')">Á∫ßÊï∞</button>
                </div>
            </div>
        </header>

        <!-- Âä©ËÆ∞ÊâãÂÜåÈù¢Êùø -->
        <div id="ref-panel">
            <table class="ref-table">
                <thead>
                    <tr>
                        <th>ÂàÜÁ±ª</th>
                        <th data-interval="3">Â∞è‰∏âÂ∫¶ (m3)</th>
                        <th data-interval="4">Â§ß‰∏âÂ∫¶ (M3)</th>
                        <th data-interval="7">Á∫Ø‰∫îÂ∫¶ (P5)</th>
                        <th data-interval="8">Â∞èÂÖ≠Â∫¶ (m6)</th>
                        <th data-interval="9">Â§ßÂÖ≠Â∫¶ (M6)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="ref-highlight">ÁôΩÁôΩ</td>
                        <td data-interval="3">D ‚Üí FÔºåE ‚Üí GÔºåA ‚Üí CÔºåB ‚Üí D</td>
                        <td data-interval="4">C ‚Üí EÔºåF ‚Üí AÔºåG ‚Üí B</td>
                        <td data-interval="7">C ‚Üí GÔºåD ‚Üí AÔºåE ‚Üí BÔºåF ‚Üí CÔºåG ‚Üí DÔºåA ‚Üí E</td>
                        <td data-interval="8">E ‚Üí CÔºåA ‚Üí FÔºåB ‚Üí G</td>
                        <td data-interval="9">C ‚Üí AÔºåD ‚Üí BÔºåF ‚Üí DÔºåG ‚Üí E</td>
                    </tr>
                    <tr>
                        <td class="ref-highlight">ÁôΩÈªë</td>
                        <td data-interval="3">C ‚Üí EbÔºåF ‚Üí AbÔºåG ‚Üí Bb</td>
                        <td data-interval="4">D ‚Üí F#ÔºåE ‚Üí AbÔºåA ‚Üí C#ÔºåB ‚Üí Eb</td>
                        <td data-interval="7">B ‚Üí F#</td>
                        <td data-interval="8">C ‚Üí AbÔºåD ‚Üí BbÔºåF ‚Üí C#ÔºåG ‚Üí Eb</td>
                        <td data-interval="9">E ‚Üí C#ÔºåA ‚Üí F#ÔºåB ‚Üí Ab</td>
                    </tr>
                    <tr>
                        <td class="ref-highlight">ÈªëÁôΩ</td>
                        <td data-interval="3">C# ‚Üí EÔºåF# ‚Üí AÔºåAb ‚Üí B</td>
                        <td data-interval="4">C# ‚Üí FÔºåEb ‚Üí GÔºåAb ‚Üí CÔºåBb ‚Üí D</td>
                        <td data-interval="7">Bb ‚Üí F</td>
                        <td data-interval="8">C# ‚Üí AÔºåEb ‚Üí BÔºåF# ‚Üí DÔºåAb ‚Üí E</td>
                        <td data-interval="9">Eb ‚Üí CÔºåAb ‚Üí FÔºåBb ‚Üí G</td>
                    </tr>
                    <tr>
                        <td class="ref-highlight">ÈªëÈªë</td>
                        <td data-interval="3">Eb ‚Üí F#ÔºåBb ‚Üí C#</td>
                        <td data-interval="4">F# ‚Üí Bb</td>
                        <td data-interval="7">C# ‚Üí AbÔºåEb ‚Üí BbÔºåF# ‚Üí C#ÔºåAb ‚Üí Eb</td>
                        <td data-interval="8">Bb ‚Üí F#</td>
                        <td data-interval="9">C# ‚Üí BbÔºåF# ‚Üí Eb</td>
                    </tr>
                </tbody>
            </table>
            <div id="degree-ref" class="degree-ref ref-hidden">
                <div class="degree-title" id="degree-ref-title"></div>
                <div class="degree-notes" id="degree-ref-notes"></div>
                <div id="degree-ref-kbd"></div>
            </div>
        </div>

        <div id="interval-panel">
            <div class="chip-grid" id="interval-grid"></div>
        </div>

        <div id="key-panel" style="display:none">
            <div class="select-group">
                <select id="keySelect"></select>
                <select id="scaleTypeSelect">
                    <option value="major">Â§ßË∞É</option>
                    <option value="minor">Ëá™ÁÑ∂Â∞èË∞É</option>
                    <option value="harmonic">ÂíåÂ£∞Â∞èË∞É</option>
                    <option value="melodic">ÊóãÂæãÂ∞èË∞É</option>
                </select>
            </div>
        </div>

        <div class="question-area">
            <div class="feedback" id="feedback"></div>
            <div class="question-text" id="question-text">...</div>
        </div>

        <div class="keyboard-wrapper">
            <div class="piano" id="piano-body"></div>
        </div>
    </div>

    <script>
        const noteNames = ['C', 'C#', 'D', 'Eb', 'E', 'F', 'F#', 'G', 'Ab', 'A', 'Bb', 'B'];
        const intervals = [
            { n: 'Â∞è‰∫å', v: 1 }, { n: 'Â§ß‰∫å', v: 2 }, { n: 'Â∞è‰∏â', v: 3 }, { n: 'Â§ß‰∏â', v: 4 },
            { n: 'Á∫ØÂõõ', v: 5 }, { n: '‰∏âÂÖ®', v: 6 }, { n: 'Á∫Ø‰∫î', v: 7 }, { n: 'Â∞èÂÖ≠', v: 8 },
            { n: 'Â§ßÂÖ≠', v: 9 }, { n: 'Â∞è‰∏É', v: 10 }, { n: 'Â§ß‰∏É', v: 11 }
        ];
        const patterns = {
            major: [0, 2, 4, 5, 7, 9, 11], minor: [0, 2, 3, 5, 7, 8, 10],
            harmonic: [0, 2, 3, 5, 7, 8, 11], melodic: [0, 2, 3, 5, 7, 9, 11]
        };

        let audioCtx = null;

        function ensureAudio() {
            if (!audioCtx) {
                const AC = window.AudioContext || window.webkitAudioContext;
                if (!AC) return null;
                audioCtx = new AC();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume().catch(() => { });
            }
            return audioCtx;
        }

        function noteIndexToFreq(noteIndex) {
            return 261.6256 * Math.pow(2, noteIndex / 12);
        }

        function playPianoNote(noteIndex, delay = 0) {
            const ctx = ensureAudio();
            if (!ctx) return;

            const now = ctx.currentTime + delay;
            const freq = noteIndexToFreq(noteIndex);

            const master = ctx.createGain();
            master.gain.setValueAtTime(0.0001, now);
            master.gain.exponentialRampToValueAtTime(0.18, now + 0.01);
            master.gain.exponentialRampToValueAtTime(0.05, now + 0.22);
            master.gain.exponentialRampToValueAtTime(0.0001, now + 1.1);

            const filter = ctx.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.setValueAtTime(2800, now);
            filter.Q.setValueAtTime(1.2, now);

            const osc1 = ctx.createOscillator();
            osc1.type = 'triangle';
            osc1.frequency.setValueAtTime(freq, now);

            const osc2 = ctx.createOscillator();
            osc2.type = 'sine';
            osc2.frequency.setValueAtTime(freq * 2, now);

            const mix2 = ctx.createGain();
            mix2.gain.setValueAtTime(0.18, now);

            osc1.connect(filter);
            osc2.connect(mix2).connect(filter);
            filter.connect(master).connect(ctx.destination);

            osc1.start(now);
            osc2.start(now);
            osc1.stop(now + 1.15);
            osc2.stop(now + 1.15);
        }

        function playIntervalPair(rootIndex, targetIndex) {
            playPianoNote(rootIndex, 0);
            playPianoNote(targetIndex, 0.22);
        }

        let currentRoot = -1, currentTarget = -1, isWaiting = false, mainMode = 'interval';

        function updateRefByIntervals(values) {
            const allCols = document.querySelectorAll('.ref-table [data-interval]');
            allCols.forEach(el => el.classList.remove('ref-col-hidden'));
            const allowed = new Set((values || []).map(v => String(v)));
            if (!allowed.size) {
                allCols.forEach(el => el.classList.add('ref-col-hidden'));
                return;
            }
            allCols.forEach(el => {
                if (!allowed.has(el.getAttribute('data-interval'))) el.classList.add('ref-col-hidden');
            });
        }

        function renderDegreeReference() {
            const base = parseInt(document.getElementById('keySelect').value || '0');
            const st = document.getElementById('scaleTypeSelect');
            const modeName = st.options[st.selectedIndex].text;
            const scale = patterns[st.value].map(v => (base + v) % 12);
            const degreeMap = {};
            scale.forEach((note, idx) => {
                degreeMap[note] = idx + 1;
            });

            document.getElementById('degree-ref-title').innerText = `${noteNames[base]}${modeName} ÂêÑÁ∫ßÈü≥‰ΩçÁΩÆ`;
            document.getElementById('degree-ref-notes').innerText = scale.map((n, i) => `${i + 1}Á∫ß ${noteNames[n]}`).join('  ¬∑  ');

            const kbdHost = document.getElementById('degree-ref-kbd');
            const kbd = document.createElement('div');
            kbd.className = 'degree-kbd';
            for (let i = 0; i < 24; i++) {
                const note = i % 12;
                const key = document.createElement('div');
                key.className = `degree-key ${[1, 3, 6, 8, 10].includes(note) ? 'black' : ''}`;
                if (scale.includes(note)) {
                    key.classList.add('hit');
                    const num = document.createElement('span');
                    num.className = 'degree-num';
                    num.innerText = degreeMap[note];
                    key.appendChild(num);
                }
                if (note === base) key.classList.add('root');
                kbd.appendChild(key);
            }
            kbdHost.innerHTML = '';
            kbdHost.appendChild(kbd);
        }

        function syncRefByMode() {
            const refTable = document.querySelector('.ref-table');
            const degreeRef = document.getElementById('degree-ref');
            if (mainMode === 'interval') {
                refTable.classList.remove('ref-hidden');
                degreeRef.classList.add('ref-hidden');
            } else {
                refTable.classList.add('ref-hidden');
                degreeRef.classList.remove('ref-hidden');
                renderDegreeReference();
            }
        }

        function init() {
            const grid = document.getElementById('interval-grid');
            intervals.forEach(item => {
                const checked = [3, 4, 7].includes(item.v) ? 'checked' : '';
                grid.innerHTML += `
    <label class="chip" data-v="${item.v}">
        <input type="checkbox" name="interval" value="${item.v}" data-name="${item.n}" ${checked} onchange="nextQuestion(true)">
        <span class="chip-content">${item.n}</span>
    </label>`;
        });

        updateRefByIntervals([3, 4, 7]);

        const piano = document.getElementById('piano-body');
        for (let i = 0; i < 24; i++) {
            const isBlack = [1, 3, 6, 8, 10].includes(i % 12);
            const key = document.createElement('div');
            key.className = `key ${isBlack ? 'black' : ''}`;
            const startHandler = (e) => { e.preventDefault(); handlePress(i); };
            key.addEventListener('mousedown', startHandler);
            key.addEventListener('touchstart', startHandler);
            piano.appendChild(key);
        }

        const ks = document.getElementById('keySelect');
        noteNames.forEach((n, i) => ks.innerHTML += `<option value="${i}">${n} Ë∞É</option>`);
        ks.addEventListener('change', () => nextQuestion(true));
        document.getElementById('scaleTypeSelect').addEventListener('change', () => nextQuestion(true));

        nextQuestion();
    }

        function toggleRef() {
            const panel = document.getElementById('ref-panel');
            const btn = document.getElementById('btn-ref');
            panel.classList.toggle('open');
            btn.classList.toggle('active');
        }

        function toggleFullScreen() {
            if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(() => { });
        } else {
            document.exitFullscreen();
        }
    }

        function switchMainMode(mode) {
            mainMode = mode;
            document.getElementById('btn-interval').classList.toggle('active', mode === 'interval');
            document.getElementById('btn-degree').classList.toggle('active', mode === 'degree');
            document.getElementById('interval-panel').style.display = mode === 'interval' ? 'block' : 'none';
            document.getElementById('key-panel').style.display = mode === 'degree' ? 'block' : 'none';
            nextQuestion(true);
        }

        function nextQuestion(reset = false) {
            isWaiting = false;
            const qEl = document.getElementById('question-text');
            document.getElementById('feedback').innerText = "";
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('target-highlight'));

        if (mainMode === 'interval') {
            const selected = Array.from(document.querySelectorAll('input[name="interval"]:checked'));
        updateRefByIntervals(selected.map(item => parseInt(item.value)));
            syncRefByMode();
            if (!selected.length) { qEl.innerText = "ËØ∑Ëá≥Â∞ëÈÄâ‰∏Ä‰∏™"; return; }
            const pick = selected[Math.floor(Math.random() * selected.length)];
            const v = parseInt(pick.value);
            currentRoot = Math.floor(Math.random() * 12);
            currentTarget = currentRoot + v;
            qEl.innerText = `${noteNames[currentRoot]} ÁöÑ ${pick.getAttribute('data-name')}`;
            document.querySelector(`.chip[data-v="${v}"]`).classList.add('target-highlight');
        } else {
            syncRefByMode();
            const base = parseInt(document.getElementById('keySelect').value);
            const st = document.getElementById('scaleTypeSelect');
            const deg = Math.floor(Math.random() * 7) + 1;
            currentRoot = base;
            currentTarget = base + patterns[st.value][deg - 1];
            qEl.innerText = `${noteNames[base]}${st.options[st.selectedIndex].text} Á¨¨ ${deg} Á∫ß`;
        }
        refreshPiano();
    }

        function refreshPiano(pressedIdx = null, isCorrect = null) {
            document.querySelectorAll('.key').forEach((key, i) => {
                if (pressedIdx === null) key.classList.remove('root', 'correct', 'wrong');
                if (i % 12 === currentRoot % 12) key.classList.add('root');
                if (i === pressedIdx) key.classList.add(isCorrect ? 'correct' : 'wrong');
            });
        }

        function handlePress(idx) {
            if (isWaiting) return;
            const fb = document.getElementById('feedback');
            if (idx % 12 === currentTarget % 12) {
                if (mainMode === 'interval') {
                    playIntervalPair(currentRoot, currentTarget);
                } else {
                    playPianoNote(idx);
                }
                fb.innerText = "EXCELLENT"; fb.style.color = "var(--correct)";
                refreshPiano(idx, true); isWaiting = true; setTimeout(nextQuestion, 700);
            } else {
                fb.innerText = "TRY AGAIN"; fb.style.color = "var(--wrong)";
                refreshPiano(idx, false);
            }
        }

        init();
    </script>
</body>

</html>

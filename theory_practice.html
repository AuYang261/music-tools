<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Piano Flow</title>
    <style>
        :root {
            --bg-dark: #0a0c0e;
            --card-bg: #16191d;
            --accent: #00d4ff;
            --accent-glow: rgba(0, 212, 255, 0.4);
            --correct: #2ecc71;
            --wrong: #ff4757;
            --white-key: #fdfdfd;
            --black-key: #252a2e;
            --text-main: #ffffff;
            --text-dim: #7f8c8d;
            --white-key-w: 48px;
            --white-key-h: 150px;
        }

        * {
            touch-action: manipulation;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            height: 100dvh;
            width: 100vw;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        #orientation-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-dark);
            z-index: 9999;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        @media (orientation: portrait) {
            #orientation-overlay {
                display: flex;
            }
        }

        .container {
            width: 100%;
            height: 100%;
            max-width: 1100px;
            background: var(--card-bg);
            padding: 15px;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow-y: auto;
            /* å…è®¸å¯¹ç…§è¡¨å±•å¼€æ—¶æ»šåŠ¨æŸ¥çœ‹ */
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-shrink: 0;
        }

        header h1 {
            margin: 0;
            font-size: 1.1rem;
            letter-spacing: 1px;
            color: var(--accent);
            cursor: pointer;
        }

        .top-ctrl {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .tool-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #fff;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: 0.2s;
        }

        .tool-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .tool-btn.active {
            background: var(--accent);
            color: #000;
        }

        .mode-selector {
            display: flex;
            gap: 4px;
            background: rgba(0, 0, 0, 0.4);
            padding: 4px;
            border-radius: 8px;
        }

        .mode-btn {
            padding: 6px 14px;
            border: none;
            border-radius: 6px;
            background: transparent;
            color: var(--text-dim);
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .mode-btn.active {
            background: var(--accent);
            color: #000;
            box-shadow: 0 0 10px var(--accent-glow);
        }

        /* å¯¹ç…§è¡¨é¢æ¿ */
        #ref-panel {
            max-height: 0;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        #ref-panel.open {
            max-height: 300px;
            padding: 10px;
            border: 1px solid rgba(0, 212, 255, 0.2);
            overflow: auto;
        }

        .ref-table {
            width: max-content;
            min-width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 0.75rem;
            color: #ccc;
        }

        .ref-table th {
            color: var(--accent);
            text-align: left;
            padding: 4px;
            border-bottom: 1px solid #333;
            background: var(--card-bg);
            position: sticky;
            top: 0;
            z-index: 3;
        }

        .ref-table td {
            padding: 4px;
            border-bottom: 1px solid #222;
        }

        .ref-table th:first-child,
        .ref-table td:first-child {
            position: sticky;
            left: 0;
            background: var(--card-bg);
            z-index: 2;
        }

        .ref-table thead th:first-child {
            z-index: 4;
        }

        .ref-col-hidden {
            display: none;
        }

        .ref-highlight {
            color: #fff;
            font-weight: bold;
        }

        .chip-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 6px;
            margin-bottom: 5px;
            flex-shrink: 0;
        }

        .chip {
            position: relative;
            cursor: pointer;
        }

        .chip input {
            position: absolute;
            opacity: 0;
        }

        .chip-content {
            display: block;
            padding: 8px 2px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            text-align: center;
            font-size: 0.75rem;
            color: #555;
            transition: 0.3s;
        }

        .chip input:checked+.chip-content {
            border-color: rgba(255, 255, 255, 0.3);
            color: #aaa;
        }

        .chip.target-highlight .chip-content {
            background: rgba(0, 212, 255, 0.2) !important;
            border-color: var(--accent) !important;
            color: var(--accent) !important;
            box-shadow: 0 0 12px var(--accent-glow);
            font-weight: bold;
            transform: scale(1.03);
        }

        .select-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            padding: 5px 0;
        }

        select {
            padding: 8px 25px 8px 12px;
            border-radius: 8px;
            background: #2d3436;
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 0.85rem;
            cursor: pointer;
        }

        .question-area {
            text-align: center;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 50px;
        }

        .feedback {
            font-size: 0.8rem;
            height: 1rem;
            margin-bottom: 3px;
            font-weight: 800;
            letter-spacing: 2px;
        }

        .question-text {
            font-size: 1.6rem;
            font-weight: 800;
            color: #fff;
        }

        .keyboard-wrapper {
            width: 100%;
            display: flex;
            justify-content: center;
            overflow-x: auto;
            padding-top: 5px;
            flex-shrink: 0;
        }

        .piano {
            display: flex;
            position: relative;
            width: fit-content;
            height: calc(var(--white-key-h) + 12px);
            background: #000;
            padding: 6px;
            border-radius: 12px;
        }

        .key {
            width: var(--white-key-w);
            height: var(--white-key-h);
            background: var(--white-key);
            border: 1px solid #ccc;
            border-radius: 0 0 5px 5px;
            cursor: pointer;
            position: relative;
            z-index: 1;
        }

        .key.black {
            width: 28px;
            height: 90px;
            background: var(--black-key);
            margin-left: -14px;
            margin-right: -14px;
            z-index: 2;
            border: none;
            border-radius: 0 0 4px 4px;
        }

        .key.root {
            background: var(--accent) !important;
            box-shadow: 0 0 15px var(--accent-glow);
        }

        .key.correct {
            background: var(--correct) !important;
        }

        .key.wrong {
            background: var(--wrong) !important;
        }

        @media (orientation: landscape) and (max-height: 450px) {
            .container {
                padding: 5px 15px;
            }

            .chip-grid {
                grid-template-columns: repeat(6, 1fr);
                gap: 4px;
            }

            .question-area {
                min-height: 35px;
            }

            .question-text {
                font-size: 1.2rem;
            }

            #ref-panel.open {
                max-height: 120px;
            }

            .container {
                --white-key-h: 100px;
                --white-key-w: 42px;
            }

            .key.black {
                height: 65px;
                width: 24px;
                margin-left: -12px;
                margin-right: -12px;
            }
        }

    </style>
</head>

<body>

    <div id="orientation-overlay">
        <span style="font-size: 3rem;">ğŸ”„</span>
        <p>è¯·æ—‹è½¬æ‰‹æœºè‡³æ¨ªå±æ¨¡å¼</p>
    </div>

    <div class="container" id="app-container">
        <header>
            <h1 onclick="location.reload()">PIANO FLOW</h1>
            <div class="top-ctrl">
                <button class="tool-btn" id="btn-ref" onclick="toggleRef()">ğŸ“š åŠ©è®°æ‰‹å†Œ</button>
                <button class="tool-btn" onclick="location.href='interval_memory.html'">ğŸ§  åŠ©è®°ä¸“é¡µ</button>
                <button class="tool-btn" onclick="toggleFullScreen()">â›¶ å…¨å±</button>
                <div class="mode-selector">
                    <button class="mode-btn active" id="btn-interval" onclick="switchMainMode('interval')">éŸ³ç¨‹</button>
                    <button class="mode-btn" id="btn-degree" onclick="switchMainMode('degree')">çº§æ•°</button>
                </div>
            </div>
        </header>

        <!-- åŠ©è®°æ‰‹å†Œé¢æ¿ -->
        <div id="ref-panel">
            <table class="ref-table">
                <thead>
                    <tr>
                        <th>åˆ†ç±»</th>
                        <th data-interval="3">å°ä¸‰åº¦ (m3)</th>
                        <th data-interval="4">å¤§ä¸‰åº¦ (M3)</th>
                        <th data-interval="7">çº¯äº”åº¦ (P5)</th>
                        <th data-interval="8">å°å…­åº¦ (m6)</th>
                        <th data-interval="9">å¤§å…­åº¦ (M6)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="ref-highlight">ç™½ç™½</td>
                        <td data-interval="3">D â†’ Fï¼ŒE â†’ Gï¼ŒA â†’ Cï¼ŒB â†’ D</td>
                        <td data-interval="4">C â†’ Eï¼ŒF â†’ Aï¼ŒG â†’ B</td>
                        <td data-interval="7">C â†’ Gï¼ŒD â†’ Aï¼ŒE â†’ Bï¼ŒF â†’ Cï¼ŒG â†’ Dï¼ŒA â†’ E</td>
                        <td data-interval="8">E â†’ Cï¼ŒA â†’ Fï¼ŒB â†’ G</td>
                        <td data-interval="9">C â†’ Aï¼ŒD â†’ Bï¼ŒF â†’ Dï¼ŒG â†’ E</td>
                    </tr>
                    <tr>
                        <td class="ref-highlight">ç™½é»‘</td>
                        <td data-interval="3">C â†’ Ebï¼ŒF â†’ Abï¼ŒG â†’ Bb</td>
                        <td data-interval="4">D â†’ F#ï¼ŒE â†’ Abï¼ŒA â†’ C#ï¼ŒB â†’ Eb</td>
                        <td data-interval="7">B â†’ F#</td>
                        <td data-interval="8">C â†’ Abï¼ŒD â†’ Bbï¼ŒF â†’ C#ï¼ŒG â†’ Eb</td>
                        <td data-interval="9">E â†’ C#ï¼ŒA â†’ F#ï¼ŒB â†’ Ab</td>
                    </tr>
                    <tr>
                        <td class="ref-highlight">é»‘ç™½</td>
                        <td data-interval="3">C# â†’ Eï¼ŒF# â†’ Aï¼ŒAb â†’ B</td>
                        <td data-interval="4">C# â†’ Fï¼ŒEb â†’ Gï¼ŒAb â†’ Cï¼ŒBb â†’ D</td>
                        <td data-interval="7">Bb â†’ F</td>
                        <td data-interval="8">C# â†’ Aï¼ŒEb â†’ Bï¼ŒF# â†’ Dï¼ŒAb â†’ E</td>
                        <td data-interval="9">Eb â†’ Cï¼ŒAb â†’ Fï¼ŒBb â†’ G</td>
                    </tr>
                    <tr>
                        <td class="ref-highlight">é»‘é»‘</td>
                        <td data-interval="3">Eb â†’ F#ï¼ŒBb â†’ C#</td>
                        <td data-interval="4">F# â†’ Bb</td>
                        <td data-interval="7">C# â†’ Abï¼ŒEb â†’ Bbï¼ŒF# â†’ C#ï¼ŒAb â†’ Eb</td>
                        <td data-interval="8">Bb â†’ F#</td>
                        <td data-interval="9">C# â†’ Bbï¼ŒF# â†’ Eb</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div id="interval-panel">
            <div class="chip-grid" id="interval-grid"></div>
        </div>

        <div id="key-panel" style="display:none">
            <div class="select-group">
                <select id="keySelect"></select>
                <select id="scaleTypeSelect">
                    <option value="major">å¤§è°ƒ</option>
                    <option value="minor">è‡ªç„¶å°è°ƒ</option>
                    <option value="harmonic">å’Œå£°å°è°ƒ</option>
                    <option value="melodic">æ—‹å¾‹å°è°ƒ</option>
                </select>
            </div>
        </div>

        <div class="question-area">
            <div class="feedback" id="feedback"></div>
            <div class="question-text" id="question-text">...</div>
        </div>

        <div class="keyboard-wrapper">
            <div class="piano" id="piano-body"></div>
        </div>
    </div>

    <script>
        const noteNames = ['C', 'C#', 'D', 'Eb', 'E', 'F', 'F#', 'G', 'Ab', 'A', 'Bb', 'B'];
        const intervals = [
            { n: 'å°äºŒ', v: 1 }, { n: 'å¤§äºŒ', v: 2 }, { n: 'å°ä¸‰', v: 3 }, { n: 'å¤§ä¸‰', v: 4 },
            { n: 'çº¯å››', v: 5 }, { n: 'ä¸‰å…¨', v: 6 }, { n: 'çº¯äº”', v: 7 }, { n: 'å°å…­', v: 8 },
            { n: 'å¤§å…­', v: 9 }, { n: 'å°ä¸ƒ', v: 10 }, { n: 'å¤§ä¸ƒ', v: 11 }
        ];
        const patterns = {
            major: [0, 2, 4, 5, 7, 9, 11], minor: [0, 2, 3, 5, 7, 8, 10],
            harmonic: [0, 2, 3, 5, 7, 8, 11], melodic: [0, 2, 3, 5, 7, 9, 11]
        };

                    let currentRoot = -1, currentTarget = -1, isWaiting = false, mainMode = 'interval';

                    function updateRefByIntervals(values) {
                        const allCols = document.querySelectorAll('.ref-table [data-interval]');
                        allCols.forEach(el => el.classList.remove('ref-col-hidden'));
                        const allowed = new Set((values || []).map(v => String(v)));
                        if (!allowed.size) {
                            allCols.forEach(el => el.classList.add('ref-col-hidden'));
                            return;
                        }
                        allCols.forEach(el => {
                            if (!allowed.has(el.getAttribute('data-interval'))) el.classList.add('ref-col-hidden');
                        });
                    }

                    function init() {
                        const grid = document.getElementById('interval-grid');
                        intervals.forEach(item => {
                            const checked = [3, 4, 7].includes(item.v) ? 'checked' : '';
                            grid.innerHTML += `
                <label class="chip" data-v="${item.v}">
                    <input type="checkbox" name="interval" value="${item.v}" data-name="${item.n}" ${checked} onchange="nextQuestion(true)">
                    <span class="chip-content">${item.n}</span>
                </label>`;
                    });

                    updateRefByIntervals([3, 4, 7]);

                    const piano = document.getElementById('piano-body');
                    for (let i = 0; i < 24; i++) {
                        const isBlack = [1, 3, 6, 8, 10].includes(i % 12);
                        const key = document.createElement('div');
                        key.className = `key ${isBlack ? 'black' : ''}`;
                        const startHandler = (e) => { e.preventDefault(); handlePress(i); };
                        key.addEventListener('mousedown', startHandler);
                        key.addEventListener('touchstart', startHandler);
                        piano.appendChild(key);
                    }

                    const ks = document.getElementById('keySelect');
                    noteNames.forEach((n, i) => ks.innerHTML += `<option value="${i}">${n} è°ƒ</option>`);
                    ks.addEventListener('change', () => nextQuestion(true));
                    document.getElementById('scaleTypeSelect').addEventListener('change', () => nextQuestion(true));

                    nextQuestion();
                }

                    function toggleRef() {
                        const panel = document.getElementById('ref-panel');
                        const btn = document.getElementById('btn-ref');
                        panel.classList.toggle('open');
                        btn.classList.toggle('active');
                    }

                    function toggleFullScreen() {
                        if (!document.fullscreenElement) {
                        document.documentElement.requestFullscreen().catch(() => { });
                    } else {
                        document.exitFullscreen();
                    }
                }

                    function switchMainMode(mode) {
                        mainMode = mode;
                        document.getElementById('btn-interval').classList.toggle('active', mode === 'interval');
                        document.getElementById('btn-degree').classList.toggle('active', mode === 'degree');
                        document.getElementById('interval-panel').style.display = mode === 'interval' ? 'block' : 'none';
                        document.getElementById('key-panel').style.display = mode === 'degree' ? 'block' : 'none';
                        nextQuestion(true);
                    }

                    function nextQuestion(reset = false) {
                        isWaiting = false;
                        const qEl = document.getElementById('question-text');
                        document.getElementById('feedback').innerText = "";
                        document.querySelectorAll('.chip').forEach(c => c.classList.remove('target-highlight'));

                    if (mainMode === 'interval') {
                        const selected = Array.from(document.querySelectorAll('input[name="interval"]:checked'));
                    updateRefByIntervals(selected.map(item => parseInt(item.value)));
                        if (!selected.length) { qEl.innerText = "è¯·è‡³å°‘é€‰ä¸€ä¸ª"; return; }
                        const pick = selected[Math.floor(Math.random() * selected.length)];
                        const v = parseInt(pick.value);
                        currentRoot = Math.floor(Math.random() * 12);
                        currentTarget = currentRoot + v;
                        qEl.innerText = `${noteNames[currentRoot]} çš„ ${pick.getAttribute('data-name')}`;
                        document.querySelector(`.chip[data-v="${v}"]`).classList.add('target-highlight');
                    } else {
                        const base = parseInt(document.getElementById('keySelect').value);
                        const st = document.getElementById('scaleTypeSelect');
                        const deg = Math.floor(Math.random() * 7) + 1;
                        currentRoot = base;
                        currentTarget = base + patterns[st.value][deg - 1];
                        qEl.innerText = `${noteNames[base]}${st.options[st.selectedIndex].text} ç¬¬ ${deg} çº§`;
                    }
                    refreshPiano();
                }

                    function refreshPiano(pressedIdx = null, isCorrect = null) {
                        document.querySelectorAll('.key').forEach((key, i) => {
                            if (pressedIdx === null) key.classList.remove('root', 'correct', 'wrong');
                            if (i % 12 === currentRoot % 12) key.classList.add('root');
                            if (i === pressedIdx) key.classList.add(isCorrect ? 'correct' : 'wrong');
                        });
                    }

                    function handlePress(idx) {
                        if (isWaiting) return;
                        const fb = document.getElementById('feedback');
                        if (idx % 12 === currentTarget % 12) {
                            fb.innerText = "EXCELLENT"; fb.style.color = "var(--correct)";
                            refreshPiano(idx, true); isWaiting = true; setTimeout(nextQuestion, 700);
                        } else {
                            fb.innerText = "TRY AGAIN"; fb.style.color = "var(--wrong)";
                            refreshPiano(idx, false);
                        }
                    }

                    init();
                </script>
</body>

</html>
